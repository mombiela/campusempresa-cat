<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spark SQL</title>

    <link rel="alternate" href="https://campusempresa.com/mod/apachespark/02-04-spark-sql" hreflang="es" />
	<link rel="alternate" href="https://campusempresa.cat/mod/apachespark/02-04-spark-sql" hreflang="ca" />
	<link rel="alternate" href="https://enterprisecampus.net/mod/apachespark/02-04-spark-sql" hreflang="en" />
    
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<link href="/css/site.css" rel="stylesheet">
	
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  	<script type="text/javascript" src="/js/math_init.js"></script>
  	<script type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js"></script>
  	<script type="text/javascript" src="/js/cookie.js"></script>
  	<script type="text/javascript" src="/js/main.js"></script>
</head>

<body >
    <div id="content">
		<div id="header" class="container-xxl">
	<div class="row">
		<div class="col-12 col-md-8 p-2 p-md-0">
			<h1 class="m-0 p-0">
				<a href="/"><img src="/img/logo_header.png"></a>
			</h1>
		</div>
		<div class="col-12 col-md-4 p-2 p-md-0 text-end">
			<h2 id="main_title"><cite>Construint la societat d'avui i del demà</cite></h2>
			<h3 id="main_subtitle"></h3>
		</div>
	</div>
</div>
<div class="container-xxl" style="margin-top: -1em;">
	<div class="row">
		<div class="col-12 p-2 p-md-0 m-0 text-end">
							<a href="https://enterprisecampus.net/mod/apachespark/02-04-spark-sql" class="px-2">EN</a></b>
				|
				<a href="https://campusempresa.com/mod/apachespark/02-04-spark-sql" class="px-2">ES</a></b>
				|
				<b class="px-2">CA</b>
											</div>
	</div>
</div>

<div class="top-bar container-fluid">
	<div class="container-xxl">
		<div class="row">
			<div class="col" id="left_menu">
				<!-- <a href="/">Home</a>  -->
									<a href="./">Contingut del curs</a>
					<span class="sep">|</span>
								<a href="/all/competencias">Competències tècniques</a>
				<a href="/all/conocimientos">Coneixements</a>
				<a href="/all/soft_skills">Competències socials</a>
			</div>
		</div>
	</div>
</div>

<div class="container-xxl" id="main_content">
	<div class="row">
		<div class="col-12 col-lg-8">
			<div id="nav1" class="navigation"></div>
			<div id="inner_content">
								<div class='row navigation'>
	<div class='col-1 col-md-2'>
					<a href='02-03-spark-dataframes' title="DataFrames de Spark">
				<span class="d-none d-md-inline">&#x25C4; Anterior</span>
				<span class="d-inline d-md-none"><i class="bi bi-caret-left-square-fill"></i></span>
			</a>
			</div>
	<div class='col-10 col-md-8 text-center'>
					<a href="./"><h2 style="text-decoration:underline">Spark SQL</h2></a>
			</div>
	<div class='col-1 col-md-2 text-end'>
					<a href='03-01-loading-saving-data' title="Carregar i Desar Dades">
				<span class="d-none d-md-inline">Següent &#x25BA;</span>
				<span class="d-inline d-md-none"><i class="bi bi-caret-right-square-fill"></i></span>
			</a>
			</div>
</div>
<div class='content'></div><h1><p>Introducció a Spark SQL</p>
</h1>
<div class='content'><p>Spark SQL és un mòdul d'Apache Spark que permet treballar amb dades estructurades utilitzant el llenguatge SQL. Proporciona una interfície per executar consultes SQL sobre dades de Spark, així com per integrar-se amb altres components de Spark com DataFrames i Datasets.</p>
</div><h2><p>Objectius del Tema</p>
</h2>
<div class='content'><ul>
<li>Comprendre què és Spark SQL i les seves funcionalitats.</li>
<li>Aprendre a crear i gestionar DataFrames utilitzant Spark SQL.</li>
<li>Executar consultes SQL sobre dades de Spark.</li>
<li>Integrar Spark SQL amb altres components de Spark.</li>
</ul>
</div><h1><p>Conceptes Clau</p>
</h1>
<div class='content'></div><h2><ol>
<li>Què és Spark SQL?</li>
</ol>
</h2>
<div class='content'><p>Spark SQL és un mòdul que permet:</p>
<ul>
<li>Executar consultes SQL sobre dades de Spark.</li>
<li>Integrar-se amb altres components de Spark com DataFrames i Datasets.</li>
<li>Connectar-se a diverses fonts de dades com HDFS, Hive, JDBC, etc.</li>
</ul>
</div><h2><ol start="2">
<li>DataFrames i Spark SQL</li>
</ol>
</h2>
<div class='content'><p>Un DataFrame és una col·lecció distribuïda de dades organitzada en columnes amb noms. És similar a una taula en una base de dades relacional o a un dataframe en R/Python.</p>
</div><h2><ol start="3">
<li>Consultes SQL</li>
</ol>
</h2>
<div class='content'><p>Spark SQL permet executar consultes SQL sobre DataFrames i altres fonts de dades. Les consultes SQL es poden escriure en el mateix codi Spark utilitzant la interfície <code>sql</code>.</p>
</div><h1><p>Exemples Pràctics</p>
</h1>
<div class='content'></div><h2><p>Creació d'un SparkSession</p>
</h2>
<div class='content'><p>Abans de començar a treballar amb Spark SQL, necessitem crear una instància de <code>SparkSession</code>, que és el punt d'entrada per a la funcionalitat de Spark SQL.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ZnJvbSBweXNwYXJrLnNxbCBpbXBvcnQgU3BhcmtTZXNzaW9uCgojIENyZWFyIHVuYSBTcGFya1Nlc3Npb24Kc3BhcmsgPSBTcGFya1Nlc3Npb24uYnVpbGRlciBcCiAgICAuYXBwTmFtZSgiU3BhcmsgU1FMIEV4YW1wbGUiKSBcCiAgICAuZ2V0T3JDcmVhdGUoKQ=="))));alert("Copiat!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>from pyspark.sql import SparkSession

# Crear una SparkSession
spark = SparkSession.builder \
    .appName(&quot;Spark SQL Example&quot;) \
    .getOrCreate()</pre></div><div class='content'></div><h2><p>Creació de DataFrames</p>
</h2>
<div class='content'><p>Podem crear DataFrames a partir de diverses fonts de dades, com ara fitxers CSV, JSON, Parquet, etc.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("IyBDYXJyZWdhciB1biBmaXR4ZXIgQ1NWIGNvbSBhIERhdGFGcmFtZQpkZiA9IHNwYXJrLnJlYWQuY3N2KCJwYXRoL3RvL2NzdmZpbGUuY3N2IiwgaGVhZGVyPVRydWUsIGluZmVyU2NoZW1hPVRydWUpCgojIE1vc3RyYXIgbGVzIHByaW1lcmVzIGZpbGVzIGRlbCBEYXRhRnJhbWUKZGYuc2hvdygp"))));alert("Copiat!");return false;'><i class='bi bi-copy'></i></a><pre class='code'># Carregar un fitxer CSV com a DataFrame
df = spark.read.csv(&quot;path/to/csvfile.csv&quot;, header=True, inferSchema=True)

# Mostrar les primeres files del DataFrame
df.show()</pre></div><div class='content'></div><h2><p>Executar Consultes SQL</p>
</h2>
<div class='content'><p>Podem registrar un DataFrame com una taula temporal i executar consultes SQL sobre ell.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("IyBSZWdpc3RyYXIgZWwgRGF0YUZyYW1lIGNvbSB1bmEgdGF1bGEgdGVtcG9yYWwKZGYuY3JlYXRlT3JSZXBsYWNlVGVtcFZpZXcoIm15X3RhYmxlIikKCiMgRXhlY3V0YXIgdW5hIGNvbnN1bHRhIFNRTApyZXN1bHQgPSBzcGFyay5zcWwoIlNFTEVDVCAqIEZST00gbXlfdGFibGUgV0hFUkUgYWdlID4gMzAiKQoKIyBNb3N0cmFyIGVsIHJlc3VsdGF0IGRlIGxhIGNvbnN1bHRhCnJlc3VsdC5zaG93KCk="))));alert("Copiat!");return false;'><i class='bi bi-copy'></i></a><pre class='code'># Registrar el DataFrame com una taula temporal
df.createOrReplaceTempView(&quot;my_table&quot;)

# Executar una consulta SQL
result = spark.sql(&quot;SELECT * FROM my_table WHERE age &gt; 30&quot;)

# Mostrar el resultat de la consulta
result.show()</pre></div><div class='content'></div><h2><p>Integració amb Altres Components de Spark</p>
</h2>
<div class='content'><p>Podem utilitzar Spark SQL conjuntament amb altres components de Spark com DataFrames i Datasets per realitzar operacions més complexes.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("IyBDcmVhciB1biBEYXRhRnJhbWUgYSBwYXJ0aXIgZCd1bmEgbGxpc3RhIGRlIHR1cGxlcwpkYXRhID0gWygiQWxpY2UiLCAzNCksICgiQm9iIiwgNDUpLCAoIkNhdGh5IiwgMjkpXQpjb2x1bW5zID0gWyJOYW1lIiwgIkFnZSJdCmRmID0gc3BhcmsuY3JlYXRlRGF0YUZyYW1lKGRhdGEsIGNvbHVtbnMpCgojIFJlZ2lzdHJhciBlbCBEYXRhRnJhbWUgY29tIHVuYSB0YXVsYSB0ZW1wb3JhbApkZi5jcmVhdGVPclJlcGxhY2VUZW1wVmlldygicGVvcGxlIikKCiMgRXhlY3V0YXIgdW5hIGNvbnN1bHRhIFNRTApyZXN1bHQgPSBzcGFyay5zcWwoIlNFTEVDVCBOYW1lLCBBZ2UgRlJPTSBwZW9wbGUgV0hFUkUgQWdlID4gMzAiKQoKIyBNb3N0cmFyIGVsIHJlc3VsdGF0IGRlIGxhIGNvbnN1bHRhCnJlc3VsdC5zaG93KCk="))));alert("Copiat!");return false;'><i class='bi bi-copy'></i></a><pre class='code'># Crear un DataFrame a partir d'una llista de tuples
data = [(&quot;Alice&quot;, 34), (&quot;Bob&quot;, 45), (&quot;Cathy&quot;, 29)]
columns = [&quot;Name&quot;, &quot;Age&quot;]
df = spark.createDataFrame(data, columns)

# Registrar el DataFrame com una taula temporal
df.createOrReplaceTempView(&quot;people&quot;)

# Executar una consulta SQL
result = spark.sql(&quot;SELECT Name, Age FROM people WHERE Age &gt; 30&quot;)

# Mostrar el resultat de la consulta
result.show()</pre></div><div class='content'></div><h1><p>Exercicis Pràctics</p>
</h1>
<div class='content'></div><h2><p>Exercici 1: Carregar i Consultar Dades</p>
</h2>
<div class='content'><ol>
<li>Carrega un fitxer CSV com a DataFrame.</li>
<li>Registra el DataFrame com una taula temporal.</li>
<li>Executa una consulta SQL per seleccionar totes les files on una columna específica compleixi una condició.</li>
</ol>
<h4>Solució</h4>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("IyBDYXJyZWdhciB1biBmaXR4ZXIgQ1NWIGNvbSBhIERhdGFGcmFtZQpkZiA9IHNwYXJrLnJlYWQuY3N2KCJwYXRoL3RvL2NzdmZpbGUuY3N2IiwgaGVhZGVyPVRydWUsIGluZmVyU2NoZW1hPVRydWUpCgojIFJlZ2lzdHJhciBlbCBEYXRhRnJhbWUgY29tIHVuYSB0YXVsYSB0ZW1wb3JhbApkZi5jcmVhdGVPclJlcGxhY2VUZW1wVmlldygibXlfdGFibGUiKQoKIyBFeGVjdXRhciB1bmEgY29uc3VsdGEgU1FMCnJlc3VsdCA9IHNwYXJrLnNxbCgiU0VMRUNUICogRlJPTSBteV90YWJsZSBXSEVSRSBjb2x1bW5fbmFtZSA+IHZhbHVlIikKCiMgTW9zdHJhciBlbCByZXN1bHRhdCBkZSBsYSBjb25zdWx0YQpyZXN1bHQuc2hvdygp"))));alert("Copiat!");return false;'><i class='bi bi-copy'></i></a><pre class='code'># Carregar un fitxer CSV com a DataFrame
df = spark.read.csv(&quot;path/to/csvfile.csv&quot;, header=True, inferSchema=True)

# Registrar el DataFrame com una taula temporal
df.createOrReplaceTempView(&quot;my_table&quot;)

# Executar una consulta SQL
result = spark.sql(&quot;SELECT * FROM my_table WHERE column_name &gt; value&quot;)

# Mostrar el resultat de la consulta
result.show()</pre></div><div class='content'></div><h2><p>Exercici 2: Agregacions i Agrupacions</p>
</h2>
<div class='content'><ol>
<li>Carrega un fitxer JSON com a DataFrame.</li>
<li>Registra el DataFrame com una taula temporal.</li>
<li>Executa una consulta SQL per agrupar les dades per una columna i calcular una agregació (com la mitjana o la suma) sobre una altra columna.</li>
</ol>
<h4>Solució</h4>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("IyBDYXJyZWdhciB1biBmaXR4ZXIgSlNPTiBjb20gYSBEYXRhRnJhbWUKZGYgPSBzcGFyay5yZWFkLmpzb24oInBhdGgvdG8vanNvbmZpbGUuanNvbiIpCgojIFJlZ2lzdHJhciBlbCBEYXRhRnJhbWUgY29tIHVuYSB0YXVsYSB0ZW1wb3JhbApkZi5jcmVhdGVPclJlcGxhY2VUZW1wVmlldygibXlfdGFibGUiKQoKIyBFeGVjdXRhciB1bmEgY29uc3VsdGEgU1FMIHBlciBhZ3J1cGFyIGkgYWdyZWdhcgpyZXN1bHQgPSBzcGFyay5zcWwoIlNFTEVDVCBjb2x1bW4xLCBBVkcoY29sdW1uMikgYXMgYXZnX3ZhbHVlIEZST00gbXlfdGFibGUgR1JPVVAgQlkgY29sdW1uMSIpCgojIE1vc3RyYXIgZWwgcmVzdWx0YXQgZGUgbGEgY29uc3VsdGEKcmVzdWx0LnNob3coKQ=="))));alert("Copiat!");return false;'><i class='bi bi-copy'></i></a><pre class='code'># Carregar un fitxer JSON com a DataFrame
df = spark.read.json(&quot;path/to/jsonfile.json&quot;)

# Registrar el DataFrame com una taula temporal
df.createOrReplaceTempView(&quot;my_table&quot;)

# Executar una consulta SQL per agrupar i agregar
result = spark.sql(&quot;SELECT column1, AVG(column2) as avg_value FROM my_table GROUP BY column1&quot;)

# Mostrar el resultat de la consulta
result.show()</pre></div><div class='content'></div><h1><p>Errors Comuns i Consells</p>
</h1>
<div class='content'></div><h2><p>Error: <code>AnalysisException: Table or view not found</code></p>
</h2>
<div class='content'><p>Aquest error es produeix quan intentes executar una consulta SQL sobre una taula que no existeix. Assegura't d'haver registrat correctament el DataFrame com una taula temporal.</p>
</div><h2><p>Consell: Utilitza <code>explain()</code></p>
</h2>
<div class='content'><p>Per entendre millor com Spark executa les teves consultes SQL, pots utilitzar el mètode <code>explain()</code> per veure el pla d'execució.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("IyBWZXVyZSBlbCBwbGEgZCdleGVjdWNpw7MgZGUgbGEgY29uc3VsdGEKcmVzdWx0LmV4cGxhaW4oKQ=="))));alert("Copiat!");return false;'><i class='bi bi-copy'></i></a><pre class='code'># Veure el pla d'execuci&oacute; de la consulta
result.explain()</pre></div><div class='content'></div><h1><p>Resum</p>
</h1>
<div class='content'><p>En aquest tema, hem après què és Spark SQL i com utilitzar-lo per treballar amb dades estructurades. Hem vist com crear i gestionar DataFrames, executar consultes SQL i integrar Spark SQL amb altres components de Spark. També hem practicat amb exercicis pràctics per reforçar els conceptes apresos. En el següent mòdul, explorarem com carregar i desar dades utilitzant Spark.</p>
</div><div class='row navigation'>
	<div class='col-1 col-md-2'>
					<a href='02-03-spark-dataframes' title="DataFrames de Spark">
				<span class="d-none d-md-inline">&#x25C4; Anterior</span>
				<span class="d-inline d-md-none"><i class="bi bi-caret-left-square-fill"></i></span>
			</a>
			</div>
	<div class='col-10 col-md-8 text-center'>
			</div>
	<div class='col-1 col-md-2 text-end'>
					<a href='03-01-loading-saving-data' title="Carregar i Desar Dades">
				<span class="d-none d-md-inline">Següent &#x25BA;</span>
				<span class="d-inline d-md-none"><i class="bi bi-caret-right-square-fill"></i></span>
			</a>
			</div>
</div>

			</div>
		</div>
		<div class="col-12 col-lg-4 publi" id="div_publi">
			<h1>Publicitat</h1>
			<p>Aquest espai està destinat a publicitat.</p>
			<p>Si vols ser patrocinador, contacta amb nosaltres per incloure enllaços en aquesta zona: <a href='mailto:admin@campusempresa.cat'>admin@campusempresa.cat</a></p>
			<p>Gràcies per col·laborar!</p>
		</div>
	</div>
</div>

   <div class="container-xxl my-3">
	<div class="row">
		<div class="col">
			<footer>&copy; Copyright 2024. Tots els drets reservats</footer>
		</div>
	</div>
</div>	

<div id="cookies_adv" style="display:none;">
	Fem servir cookies per millorar la teva experiència d'ús i oferir continguts adaptats als teus interessos
    <a href="#" id="btn_accept_cookies" class="button">Acceptar</a>
    <a href="/cookies">Més informació</a>
</div>	

	</div>    
</body>
</html>
