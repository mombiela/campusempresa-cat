<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ombrejat Diferit</title>

    <link rel="alternate" href="https://campusempresa.com/mod/direct_x/07-01-deferred-shading" hreflang="es" />
	<link rel="alternate" href="https://campusempresa.cat/mod/direct_x/07-01-deferred-shading" hreflang="ca" />
	<link rel="alternate" href="https://enterprisecampus.net/mod/direct_x/07-01-deferred-shading" hreflang="en" />
    
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<link href="/css/site.css" rel="stylesheet">
	
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  	<script type="text/javascript" src="/js/math_init.js"></script>
  	<script type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js"></script>
  	<script type="text/javascript" src="/js/cookie.js"></script>
  	<script type="text/javascript" src="/js/main.js"></script>
</head>

<body >
    <div id="content">
		<div id="header" class="container-xxl">
	<div class="row">
		<div class="col-12 col-md-8 p-0">
			<h1 class="m-0 p-0">
				<a href="/"><img src="/img/logo_header.png"></a>
			</h1>
		</div>
		<div class="col-12 col-md-4 px-0 py-2 py-md-0 text-end">
			<h2 id="main_title"><cite>Construint la societat d'avui i del demà</cite></h2>
			<h3 id="main_subtitle"></h3>
		</div>
	</div>
</div>
<div class="container-xxl" style="margin-top: -1em;">
	<div class="row">
		<div class="col-12 px-0 py-2 py-md-0 m-0 text-end">
							<a href="https://enterprisecampus.net/mod/direct_x/07-01-deferred-shading" class="px-2">EN</a></b>
				|
				<a href="https://campusempresa.com/mod/direct_x/07-01-deferred-shading" class="px-2">ES</a></b>
				|
				<b class="px-2">CA</b>
											</div>
	</div>
</div>
   <div class="top-bar container-fluid">
	<div class="container-xxl">
		<div class="row">
			<div class="col" id="left_menu">
				<a href="/objective">El Projecte</a>
				<a href="/about">Sobre nosaltres</a>
				<a href="/contribute">Contribuir</a>
				<a href="/donate">Donacions</a>
				<a href="/licence">Llicència</a>
			</div>
		</div>
	</div>
   </div>

<div class="container-xxl" id="main_content">
	<div class="row">
		<div class="col-12 col-lg-8">
			<div id="nav1" class="navigation"></div>
			<div id="inner_content">
								<div class='row navigation'>
	<div class='col-2'>
					<a href='06-04-multithreading-directx' title="Multifil en DirectX">&#x25C4;Anterior</a>
			</div>
	<div class='col-8 text-center'>
					<a href="./"><h2 style="text-decoration:underline">Ombrejat Diferit</h2></a>
			</div>
	<div class='col-2 text-end'>
					<a href='07-02-post-processing-effects' title="Efectes de Postprocessament">Següent &#x25BA;</a>
			</div>
</div>
<div class='content'></div><h1>Introducció</h1>
<div class='content'><p>L'ombrejat diferit (Deferred Shading) és una tècnica avançada de renderització que permet aplicar múltiples llums a una escena de manera més eficient que amb l'ombrejat directe (Forward Shading). Aquesta tècnica és especialment útil en escenes amb un gran nombre de fonts de llum, ja que redueix la complexitat de càlcul per píxel.</p>
</div><h1>Conceptes Clau</h1>
<div class='content'><ol>
<li><strong>G-Buffer (Geometry Buffer)</strong>: Un conjunt de textures que emmagatzemen informació geomètrica de l'escena, com ara posicions, normals i colors.</li>
<li><strong>Passada de Geometria</strong>: La primera fase de l'ombrejat diferit, on es renderitza la geometria de l'escena i es guarda la informació al G-Buffer.</li>
<li><strong>Passada de Llum</strong>: La segona fase, on es processa la informació del G-Buffer per calcular la il·luminació final de cada píxel.</li>
<li><strong>Passada de Composició</strong>: La fase final, on es combinen els resultats de la passada de llum per produir la imatge final.</li>
</ol>
</div><h1>Avantatges i Desavantatges</h1>
<div class='content'></div><h2>Avantatges</h2>
<div class='content'><ul>
<li><strong>Escalabilitat</strong>: Permet gestionar un gran nombre de llums de manera més eficient.</li>
<li><strong>Flexibilitat</strong>: Facilita l'aplicació de tècniques avançades de postprocessament.</li>
</ul>
</div><h2>Desavantatges</h2>
<div class='content'><ul>
<li><strong>Memòria</strong>: Requereix més memòria per emmagatzemar el G-Buffer.</li>
<li><strong>Compatibilitat</strong>: Pot ser més complex d'implementar en maquinari més antic.</li>
</ul>
</div><h1>Implementació de l'Ombrejat Diferit</h1>
<div class='content'></div><h2>Passada de Geometria</h2>
<div class='content'><p>En aquesta fase, es renderitza la geometria de l'escena i es guarda la informació necessària al G-Buffer.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Ly8gVmVydGV4IFNoYWRlcgpzdHJ1Y3QgVlNfT1VUUFVUIHsKICAgIGZsb2F0NCBQb3MgOiBTVl9QT1NJVElPTjsKICAgIGZsb2F0MyBOb3JtYWwgOiBOT1JNQUw7CiAgICBmbG9hdDIgVGV4Q29vcmQgOiBURVhDT09SRDA7Cn07CgpWU19PVVRQVVQgVlNfTWFpbihmbG9hdDMgUG9zIDogUE9TSVRJT04sIGZsb2F0MyBOb3JtYWwgOiBOT1JNQUwsIGZsb2F0MiBUZXhDb29yZCA6IFRFWENPT1JEMCkgewogICAgVlNfT1VUUFVUIG91dHB1dDsKICAgIG91dHB1dC5Qb3MgPSBtdWwoZmxvYXQ0KFBvcywgMS4wKSwgV29ybGRWaWV3UHJvaik7CiAgICBvdXRwdXQuTm9ybWFsID0gbXVsKGZsb2F0NChOb3JtYWwsIDAuMCksIFdvcmxkKS54eXo7CiAgICBvdXRwdXQuVGV4Q29vcmQgPSBUZXhDb29yZDsKICAgIHJldHVybiBvdXRwdXQ7Cn0KCi8vIFBpeGVsIFNoYWRlcgpzdHJ1Y3QgUFNfT1VUUFVUIHsKICAgIGZsb2F0NCBDb2xvciA6IFNWX1RBUkdFVDA7CiAgICBmbG9hdDMgTm9ybWFsIDogU1ZfVEFSR0VUMTsKICAgIGZsb2F0MyBQb3NpdGlvbiA6IFNWX1RBUkdFVDI7Cn07CgpQU19PVVRQVVQgUFNfTWFpbihWU19PVVRQVVQgaW5wdXQpIHsKICAgIFBTX09VVFBVVCBvdXRwdXQ7CiAgICBvdXRwdXQuQ29sb3IgPSB0ZXh0dXJlLlNhbXBsZShzYW1wbGVyLCBpbnB1dC5UZXhDb29yZCk7CiAgICBvdXRwdXQuTm9ybWFsID0gbm9ybWFsaXplKGlucHV0Lk5vcm1hbCk7CiAgICBvdXRwdXQuUG9zaXRpb24gPSBpbnB1dC5Qb3MueHl6OwogICAgcmV0dXJuIG91dHB1dDsKfQ=="))));alert("Copiat!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>// Vertex Shader
struct VS_OUTPUT {
    float4 Pos : SV_POSITION;
    float3 Normal : NORMAL;
    float2 TexCoord : TEXCOORD0;
};

VS_OUTPUT VS_Main(float3 Pos : POSITION, float3 Normal : NORMAL, float2 TexCoord : TEXCOORD0) {
    VS_OUTPUT output;
    output.Pos = mul(float4(Pos, 1.0), WorldViewProj);
    output.Normal = mul(float4(Normal, 0.0), World).xyz;
    output.TexCoord = TexCoord;
    return output;
}

// Pixel Shader
struct PS_OUTPUT {
    float4 Color : SV_TARGET0;
    float3 Normal : SV_TARGET1;
    float3 Position : SV_TARGET2;
};

PS_OUTPUT PS_Main(VS_OUTPUT input) {
    PS_OUTPUT output;
    output.Color = texture.Sample(sampler, input.TexCoord);
    output.Normal = normalize(input.Normal);
    output.Position = input.Pos.xyz;
    return output;
}</pre></div><div class='content'></div><h2>Passada de Llum</h2>
<div class='content'><p>En aquesta fase, es processa la informació del G-Buffer per calcular la il·luminació final de cada píxel.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Ly8gUGl4ZWwgU2hhZGVyIGZvciBMaWdodCBQYXNzCmZsb2F0NCBQU19MaWdodChmbG9hdDIgVGV4Q29vcmQgOiBURVhDT09SRDApIDogU1ZfVEFSR0VUIHsKICAgIGZsb2F0MyBQb3NpdGlvbiA9IGdCdWZmZXJQb3NpdGlvbi5TYW1wbGUoc2FtcGxlciwgVGV4Q29vcmQpLnh5ejsKICAgIGZsb2F0MyBOb3JtYWwgPSBub3JtYWxpemUoZ0J1ZmZlck5vcm1hbC5TYW1wbGUoc2FtcGxlciwgVGV4Q29vcmQpLnh5eik7CiAgICBmbG9hdDQgQ29sb3IgPSBnQnVmZmVyQ29sb3IuU2FtcGxlKHNhbXBsZXIsIFRleENvb3JkKTsKCiAgICBmbG9hdDMgTGlnaHREaXIgPSBub3JtYWxpemUoTGlnaHRQb3NpdGlvbiAtIFBvc2l0aW9uKTsKICAgIGZsb2F0IE5kb3RMID0gbWF4KGRvdChOb3JtYWwsIExpZ2h0RGlyKSwgMC4wKTsKCiAgICBmbG9hdDMgRGlmZnVzZSA9IExpZ2h0Q29sb3IgKiBDb2xvci5yZ2IgKiBOZG90TDsKICAgIHJldHVybiBmbG9hdDQoRGlmZnVzZSwgMS4wKTsKfQ=="))));alert("Copiat!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>// Pixel Shader for Light Pass
float4 PS_Light(float2 TexCoord : TEXCOORD0) : SV_TARGET {
    float3 Position = gBufferPosition.Sample(sampler, TexCoord).xyz;
    float3 Normal = normalize(gBufferNormal.Sample(sampler, TexCoord).xyz);
    float4 Color = gBufferColor.Sample(sampler, TexCoord);

    float3 LightDir = normalize(LightPosition - Position);
    float NdotL = max(dot(Normal, LightDir), 0.0);

    float3 Diffuse = LightColor * Color.rgb * NdotL;
    return float4(Diffuse, 1.0);
}</pre></div><div class='content'></div><h2>Passada de Composició</h2>
<div class='content'><p>Finalment, es combinen els resultats de la passada de llum per produir la imatge final.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Ly8gUGl4ZWwgU2hhZGVyIGZvciBDb21wb3NpdGlvbiBQYXNzCmZsb2F0NCBQU19Db21wb3NlKGZsb2F0MiBUZXhDb29yZCA6IFRFWENPT1JEMCkgOiBTVl9UQVJHRVQgewogICAgZmxvYXQ0IEZpbmFsQ29sb3IgPSBmbG9hdDQoMCwgMCwgMCwgMSk7CiAgICBmb3IgKGludCBpID0gMDsgaSA8IE51bUxpZ2h0czsgKytpKSB7CiAgICAgICAgRmluYWxDb2xvciArPSBQU19MaWdodChUZXhDb29yZCk7CiAgICB9CiAgICByZXR1cm4gRmluYWxDb2xvcjsKfQ=="))));alert("Copiat!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>// Pixel Shader for Composition Pass
float4 PS_Compose(float2 TexCoord : TEXCOORD0) : SV_TARGET {
    float4 FinalColor = float4(0, 0, 0, 1);
    for (int i = 0; i &lt; NumLights; ++i) {
        FinalColor += PS_Light(TexCoord);
    }
    return FinalColor;
}</pre></div><div class='content'></div><h1>Exercici Pràctic</h1>
<div class='content'></div><h2>Objectiu</h2>
<div class='content'><p>Implementar un sistema d'ombrejat diferit en una escena simple amb múltiples llums.</p>
</div><h2>Passos</h2>
<div class='content'><ol>
<li><strong>Crear el G-Buffer</strong>: Configura les textures necessàries per emmagatzemar la informació geomètrica.</li>
<li><strong>Implementar la Passada de Geometria</strong>: Escriu els shaders per omplir el G-Buffer.</li>
<li><strong>Implementar la Passada de Llum</strong>: Escriu els shaders per calcular la il·luminació a partir del G-Buffer.</li>
<li><strong>Implementar la Passada de Composició</strong>: Combina els resultats de la passada de llum per obtenir la imatge final.</li>
</ol>
</div><h2>Solució</h2>
<div class='content'></div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Ly8gQ29uZmlndXJhY2nDsyBkZWwgRy1CdWZmZXIKSUQzRDExVGV4dHVyZTJEKiBnQnVmZmVyVGV4dHVyZXNbM107CklEM0QxMVJlbmRlclRhcmdldFZpZXcqIGdCdWZmZXJSVFZzWzNdOwpJRDNEMTFTaGFkZXJSZXNvdXJjZVZpZXcqIGdCdWZmZXJTUlZzWzNdOwoKLy8gSW5pY2lhbGl0emFjacOzIGRlbCBHLUJ1ZmZlcgpmb3IgKGludCBpID0gMDsgaSA8IDM7ICsraSkgewogICAgRDNEMTFfVEVYVFVSRTJEX0RFU0MgZGVzYyA9IHt9OwogICAgZGVzYy5XaWR0aCA9IFdpZHRoOwogICAgZGVzYy5IZWlnaHQgPSBIZWlnaHQ7CiAgICBkZXNjLk1pcExldmVscyA9IDE7CiAgICBkZXNjLkFycmF5U2l6ZSA9IDE7CiAgICBkZXNjLkZvcm1hdCA9IERYR0lfRk9STUFUX1IzMkczMkIzMkEzMl9GTE9BVDsKICAgIGRlc2MuU2FtcGxlRGVzYy5Db3VudCA9IDE7CiAgICBkZXNjLlVzYWdlID0gRDNEMTFfVVNBR0VfREVGQVVMVDsKICAgIGRlc2MuQmluZEZsYWdzID0gRDNEMTFfQklORF9SRU5ERVJfVEFSR0VUIHwgRDNEMTFfQklORF9TSEFERVJfUkVTT1VSQ0U7CiAgICBkZXZpY2UtPkNyZWF0ZVRleHR1cmUyRCgmZGVzYywgbnVsbHB0ciwgJmdCdWZmZXJUZXh0dXJlc1tpXSk7CiAgICBkZXZpY2UtPkNyZWF0ZVJlbmRlclRhcmdldFZpZXcoZ0J1ZmZlclRleHR1cmVzW2ldLCBudWxscHRyLCAmZ0J1ZmZlclJUVnNbaV0pOwogICAgZGV2aWNlLT5DcmVhdGVTaGFkZXJSZXNvdXJjZVZpZXcoZ0J1ZmZlclRleHR1cmVzW2ldLCBudWxscHRyLCAmZ0J1ZmZlclNSVnNbaV0pOwp9CgovLyBQYXNzYWRhIGRlIEdlb21ldHJpYQpjb250ZXh0LT5PTVNldFJlbmRlclRhcmdldHMoMywgZ0J1ZmZlclJUVnMsIGRlcHRoU3RlbmNpbFZpZXcpOwpjb250ZXh0LT5WU1NldFNoYWRlcihnZW9tZXRyeVZTLCBudWxscHRyLCAwKTsKY29udGV4dC0+UFNTZXRTaGFkZXIoZ2VvbWV0cnlQUywgbnVsbHB0ciwgMCk7CmNvbnRleHQtPkRyYXdJbmRleGVkKGluZGV4Q291bnQsIDAsIDApOwoKLy8gUGFzc2FkYSBkZSBMbHVtCmNvbnRleHQtPk9NU2V0UmVuZGVyVGFyZ2V0cygxLCAmbGlnaHRSVFYsIG51bGxwdHIpOwpjb250ZXh0LT5QU1NldFNoYWRlclJlc291cmNlcygwLCAzLCBnQnVmZmVyU1JWcyk7CmNvbnRleHQtPlBTU2V0U2hhZGVyKGxpZ2h0UFMsIG51bGxwdHIsIDApOwpjb250ZXh0LT5EcmF3KDMsIDApOwoKLy8gUGFzc2FkYSBkZSBDb21wb3NpY2nDswpjb250ZXh0LT5PTVNldFJlbmRlclRhcmdldHMoMSwgJmZpbmFsUlRWLCBudWxscHRyKTsKY29udGV4dC0+UFNTZXRTaGFkZXIoY29tcG9zZVBTLCBudWxscHRyLCAwKTsKY29udGV4dC0+RHJhdygzLCAwKTs="))));alert("Copiat!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>// Configuraci&oacute; del G-Buffer
ID3D11Texture2D* gBufferTextures[3];
ID3D11RenderTargetView* gBufferRTVs[3];
ID3D11ShaderResourceView* gBufferSRVs[3];

// Inicialitzaci&oacute; del G-Buffer
for (int i = 0; i &lt; 3; ++i) {
    D3D11_TEXTURE2D_DESC desc = {};
    desc.Width = Width;
    desc.Height = Height;
    desc.MipLevels = 1;
    desc.ArraySize = 1;
    desc.Format = DXGI_FORMAT_R32G32B32A32_FLOAT;
    desc.SampleDesc.Count = 1;
    desc.Usage = D3D11_USAGE_DEFAULT;
    desc.BindFlags = D3D11_BIND_RENDER_TARGET | D3D11_BIND_SHADER_RESOURCE;
    device-&gt;CreateTexture2D(&amp;desc, nullptr, &amp;gBufferTextures[i]);
    device-&gt;CreateRenderTargetView(gBufferTextures[i], nullptr, &amp;gBufferRTVs[i]);
    device-&gt;CreateShaderResourceView(gBufferTextures[i], nullptr, &amp;gBufferSRVs[i]);
}

// Passada de Geometria
context-&gt;OMSetRenderTargets(3, gBufferRTVs, depthStencilView);
context-&gt;VSSetShader(geometryVS, nullptr, 0);
context-&gt;PSSetShader(geometryPS, nullptr, 0);
context-&gt;DrawIndexed(indexCount, 0, 0);

// Passada de Llum
context-&gt;OMSetRenderTargets(1, &amp;lightRTV, nullptr);
context-&gt;PSSetShaderResources(0, 3, gBufferSRVs);
context-&gt;PSSetShader(lightPS, nullptr, 0);
context-&gt;Draw(3, 0);

// Passada de Composici&oacute;
context-&gt;OMSetRenderTargets(1, &amp;finalRTV, nullptr);
context-&gt;PSSetShader(composePS, nullptr, 0);
context-&gt;Draw(3, 0);</pre></div><div class='content'></div><h1>Resum</h1>
<div class='content'><p>L'ombrejat diferit és una tècnica poderosa per gestionar escenes amb múltiples llums de manera eficient. Tot i que requereix més memòria i pot ser més complex d'implementar, els seus avantatges en termes de rendiment i flexibilitat el fan una opció atractiva per a aplicacions gràfiques avançades. Amb la pràctica i la comprensió dels conceptes clau, podràs implementar aquesta tècnica en els teus projectes DirectX.</p>
</div><div class='row navigation'>
	<div class='col-2'>
					<a href='06-04-multithreading-directx' title="Multifil en DirectX">&#x25C4;Anterior</a>
			</div>
	<div class='col-8 text-center'>
			</div>
	<div class='col-2 text-end'>
					<a href='07-02-post-processing-effects' title="Efectes de Postprocessament">Següent &#x25BA;</a>
			</div>
</div>

			</div>
		</div>
		<div class="col-12 col-lg-4 publi" id="div_publi">
			<h1>Publicitat</h1>
			<p>Aquest espai està destinat a publicitat.</p>
			<p>Si vols ser patrocinador, contacta amb nosaltres per incloure enllaços en aquesta zona: <a href='mailto:admin@campusempresa.cat'>admin@campusempresa.cat</a></p>
			<p>Gràcies per col·laborar!</p>
		</div>
	</div>
</div>

   <div class="container-xxl my-3">
	<div class="row">
		<div class="col">
			<footer>&copy; Copyright 2024. Tots els drets reservats</footer>
		</div>
	</div>
</div>	

<div id="cookies_adv" style="display:none;">
	Fem servir galetes per millorar la teva experiència d'ús i oferir continguts adaptats als teus interessos
    <a href="#" id="btn_accept_cookies" class="button">Acceptar</a>
    <a href="/cookies">Més informació</a>
</div>	

	</div>    
</body>
</html>
